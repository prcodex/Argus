<!DOCTYPE html>
<html>
<head>
    <title>Scrapex Admin - Email Intelligence System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; margin-bottom: 30px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #ddd; }
        .tab { padding: 12px 24px; cursor: pointer; background: #f8f9fa; border: 1px solid #ddd; border-bottom: none; border-radius: 8px 8px 0 0; transition: all 0.3s; }
        .tab:hover { background: #e9ecef; }
        .tab.active { background: white; border-bottom: 2px solid white; margin-bottom: -2px; font-weight: bold; color: #007bff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tag-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .tag-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .tag-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .tag-card h3 { margin: 0 0 10px 0; font-size: 18px; }
        .tag-card p { margin: 0; font-size: 13px; opacity: 0.9; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; text-align: left; }
        table td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        table tr:hover { background: #f8f9fa; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 40px; border-radius: 15px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .form-group select, .form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .preview-box { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff; margin: 25px 0; }
        .preview-box strong { color: #007bff; font-size: 16px; }
        .preview-box pre { margin-top: 12px; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; transition: all 0.3s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,123,255,0.3); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        .btn-info { background: #17a2b8; color: white; width: 100%; margin-bottom: 15px; }
        .btn-info:hover { background: #117a8b; }
        .btn-small { padding: 8px 16px; font-size: 13px; }
        .btn-actions { display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px; }
        .handler-badge { display: inline-block; background: #28a745; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìß Scrapex Admin - Email Intelligence System</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('senders')">üì¨ Allowed Senders</div>
            <div class="tab" onclick="switchTab('mappings')">üè∑Ô∏è Tag Mappings</div>
            <div class="tab" onclick="switchTab('rules')">‚öôÔ∏è Detection Rules</div>
            <div class="tab" onclick="switchTab('blocked')">üö´ Blocked Senders</div>
        </div>
        
        <div id="senders-content" class="tab-content active">
            <h2>Allowed Email Senders</h2>
            <div id="senders-list">Loading...</div>
        </div>
        
        <div id="mappings-content" class="tab-content">
            <h2>Tag to Handler Mappings - Edit Handlers</h2>
            <p style="color: #666; margin-bottom: 20px;">Each tag is assigned an enrichment handler. Click Edit to change the handler.</p>
            
            <table>
                <thead>
                    <tr>
                        <th style="width: 35%;">üìß Tag</th>
                        <th style="width: 45%;">‚öôÔ∏è Current Handler</th>
                        <th style="width: 20%; text-align: center;">‚úèÔ∏è Actions</th>
                    </tr>
                </thead>
                <tbody id="mappings-table-body">
                    <tr><td colspan="3" style="padding: 20px; text-align: center;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div id="rules-content" class="tab-content">
            <h2>Detection Rules - Click to Edit</h2>
            <div class="tag-grid" id="rules-grid">Loading...</div>
        </div>
        
        <div id="blocked-content" class="tab-content">
            <h2>Blocked Senders</h2>
            <div id="blocked-list">Loading...</div>
        </div>
    </div>
    
    <!-- Edit Rule Modal -->
    <div id="edit-rule-modal" class="modal">
        <div class="modal-content">
            <h2>‚úèÔ∏è Edit Detection Rule: <span id="modal-tag-name"></span></h2>
            
            <div class="form-group">
                <label>üìß FROM (Sender):</label>
                <select id="rule-sender">
                    <option value="">-- Select Sender --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>üìù SUBJECT CONTAINS:</label>
                <input type="text" id="rule-subject" placeholder="e.g., Early Morning with Dave">
            </div>
            
            <div class="form-group">
                <label>üìÑ BODY CONTAINS:</label>
                <input type="text" id="rule-body" placeholder="e.g., Fundamental Recommendations">
            </div>
            
            <div class="form-group">
                <label>üîó Logic:</label>
                <select id="rule-logic">
                    <option value="OR">OR (subject OR body matches)</option>
                    <option value="AND">AND (subject AND body must match)</option>
                </select>
            </div>
            
            <div class="preview-box">
                <strong>üí° Live Preview:</strong>
                <pre id="rule-preview">Loading...</pre>
            </div>
            
            <div id="test-results" style="display: none; margin-top: 25px;">
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; border-radius: 8px;">
                    <strong style="font-size: 16px; color: #856404;">üß™ Test Results:</strong>
                    <div id="test-results-content" style="margin-top: 15px;"></div>
                </div>
            </div>
            
            <button type="button" class="btn btn-info" onclick="testRule()">üß™ Test Rule (Show Matching Emails)</button>
            
            <div class="btn-actions">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveRule()">üíæ Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Handler Modal -->
    <div id="edit-handler-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2>‚úèÔ∏è Edit Handler for: <span id="edit-tag-name" style="color: #667eea;"></span></h2>
            
            <div class="form-group">
                <label>Current Handler:</label>
                <div id="current-handler" style="padding: 12px; background: #f8f9fa; border-radius: 6px; font-family: monospace; color: #495057; font-weight: bold;"></div>
            </div>
            
            <div class="form-group">
                <label>New Handler:</label>
                <select id="new-handler-select" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: monospace;">
                    <option value="">-- Select Handler --</option>
                </select>
            </div>
            
            <div class="preview-box">
                <strong>üìã Handler Info:</strong>
                <div id="handler-description" style="margin-top: 10px; color: #666;">Select a handler to see details</div>
            </div>
            
            <div class="btn-actions">
                <button class="btn btn-secondary" onclick="closeEditHandlerModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveHandlerMapping()">üíæ Save Changes</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentTag = '';
        let currentEditTag = '';
        let currentHandler = '';
        let allowedSenders = [];
        let availableHandlers = [];
        
        // Handler descriptions
        const HANDLER_INFO = {
            'newsbrief_with_links': 'NewsBrief - Story-by-story summaries for daily briefings',
            'gold_standard_enhanced': 'Gold Standard Enhanced - Deep dive analysis (2,500-3,500 chars)',
            'rosenberg_deep_research': 'Rosenberg Deep Research - Comprehensive 5-7 bullets',
            'breakfast_headlines': 'Breakfast with Dave - Headlines list format',
            'cochrane_detailed': 'Cochrane Detailed - Academic analysis with citations',
            'itau_daily': 'Itau Daily - Portuguese summaries with actors/themes',
            'tony_pasquariello': 'Tony Pasquariello - Numbered structure, conversational tone',
            'wsj_opinion': 'WSJ Opinion - Title-only display for teasers',
            'shadow_vlm': 'Shadow Price VLM - Visual/chart analysis',
            'charts_vlm': 'Charts VLM - Chart-focused analysis',
            'elerian_rep': 'El-Erian Rep - Specialized format'
        };
        
        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-content').classList.add('active');
            
            if (tabName === 'senders') loadSenders();
            if (tabName === 'mappings') loadMappings();
            if (tabName === 'rules') loadRules();
            if (tabName === 'blocked') loadBlocked();
        }
        
        // Load functions
        function loadSenders() {
            fetch('/api/allowed_senders')
                .then(r => r.json())
                .then(data => {
                    allowedSenders = data.senders || [];
                    document.getElementById('senders-list').innerHTML = 
                        '<ul>' + allowedSenders.map(s => `<li>${s}</li>`).join('') + '</ul>';
                });
        }
        
        function loadMappings() {
            Promise.all([
                fetch('/api/tag_mappings_data').then(r => r.json()),
                fetch('/api/available_handlers').then(r => r.json())
            ]).then(([mappings, handlersData]) => {
                availableHandlers = handlersData.handlers || [];
                
                const tbody = document.getElementById('mappings-table-body');
                tbody.innerHTML = '';
                
                Object.keys(mappings).sort().forEach(tag => {
                    const handler = mappings[tag];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${tag}</strong></td>
                        <td><span class="handler-badge">${handler}</span></td>
                        <td style="text-align: center;">
                            <button class="btn btn-primary btn-small" onclick="openEditHandlerModal('${tag}', '${handler}')">
                                ‚úèÔ∏è Edit
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }
        
        function loadRules() {
            fetch('/api/detection_rules')
                .then(r => r.json())
                .then(data => {
                    const grid = document.getElementById('rules-grid');
                    grid.innerHTML = '';
                    
                    Object.keys(data).forEach(tag => {
                        const rule = data[tag];
                        const card = document.createElement('div');
                        card.className = 'tag-card';
                        card.onclick = () => openEditModal(tag, rule);
                        card.innerHTML = `<h3>${tag}</h3><p>Click to edit detection rule</p>`;
                        grid.appendChild(card);
                    });
                });
        }
        
        function loadBlocked() {
            document.getElementById('blocked-list').innerHTML = '<p>Blocked senders list</p>';
        }
        
        // Edit Handler Modal
        function openEditHandlerModal(tag, handler) {
            currentEditTag = tag;
            currentHandler = handler;
            
            document.getElementById('edit-tag-name').textContent = tag;
            document.getElementById('current-handler').textContent = handler;
            
            // Populate handler dropdown
            const select = document.getElementById('new-handler-select');
            select.innerHTML = '<option value="">-- Select Handler --</option>' +
                availableHandlers.map(h => `<option value="${h}">${h}</option>`).join('');
            
            // Show description
            document.getElementById('handler-description').textContent = 
                'Select a handler to see details';
            
            document.getElementById('edit-handler-modal').classList.add('active');
        }
        
        function closeEditHandlerModal() {
            document.getElementById('edit-handler-modal').classList.remove('active');
        }
        
        async function saveHandlerMapping() {
            const newHandler = document.getElementById('new-handler-select').value;
            
            if (!newHandler) {
                alert('‚ùå Please select a new handler!');
                return;
            }
            
            if (newHandler === currentHandler) {
                alert('‚ÑπÔ∏è Handler is the same - no changes needed');
                return;
            }
            
            if (!confirm(`Change handler for "${currentEditTag}"?\n\nFrom: ${currentHandler}\nTo: ${newHandler}`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/update_tag_mapping', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        tag: currentEditTag,
                        handler: newHandler
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Handler updated!\n\nTag: ${result.tag}\nOld: ${result.old_handler}\nNew: ${result.new_handler}`);
                    closeEditHandlerModal();
                    loadMappings(); // Refresh the table
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (e) {
                alert(`‚ùå Error saving: ${e}`);
            }
        }
        
        // Edit Rule Modal
        function openEditModal(tag, rule) {
            currentTag = tag;
            document.getElementById('modal-tag-name').textContent = tag;
            document.getElementById('edit-rule-modal').classList.add('active');
            
            // Populate sender dropdown
            const senderSelect = document.getElementById('rule-sender');
            senderSelect.innerHTML = '<option value="">-- Select Sender --</option>' +
                allowedSenders.map(s => `<option value="${s}">${s}</option>`).join('');
            
            // Populate fields
            document.getElementById('rule-sender').value = rule.sender || '';
            document.getElementById('rule-subject').value = rule.subject_contains || '';
            document.getElementById('rule-body').value = rule.body_contains || '';
            document.getElementById('rule-logic').value = rule.logic || 'OR';
            
            updatePreview();
            document.getElementById('test-results').style.display = 'none';
        }
        
        function closeEditModal() {
            document.getElementById('edit-rule-modal').classList.remove('active');
        }
        
        function updatePreview() {
            const sender = document.getElementById('rule-sender').value;
            const subject = document.getElementById('rule-subject').value;
            const body = document.getElementById('rule-body').value;
            const logic = document.getElementById('rule-logic').value;
            
            let preview = '';
            
            if (sender) {
                preview += `FROM: ${sender}\n`;
            }
            
            if (subject || body) {
                if (sender) preview += 'AND ';
                preview += '(';
                
                if (subject) {
                    preview += `subject contains "${subject}"`;
                }
                
                if (subject && body) {
                    preview += `\n     ${logic} `;
                }
                
                if (body) {
                    preview += `body contains "${body}"`;
                }
                
                preview += ')';
            }
            
            if (!sender && !subject && !body) {
                preview = 'No conditions set - this will match nothing';
            }
            
            document.getElementById('rule-preview').textContent = preview;
        }
        
        async function testRule() {
            const sender = document.getElementById('rule-sender').value;
            const subject = document.getElementById('rule-subject').value;
            const body = document.getElementById('rule-body').value;
            const logic = document.getElementById('rule-logic').value;
            
            if (!sender) {
                alert('‚ùå Please select a sender first!');
                return;
            }
            
            const resultsDiv = document.getElementById('test-results');
            const contentDiv = document.getElementById('test-results-content');
            resultsDiv.style.display = 'block';
            contentDiv.innerHTML = '‚è≥ Testing rule against your emails...';
            
            try {
                const response = await fetch('/api/test_rule', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({sender, subject_contains: subject, body_contains: body, logic})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const matches = result.matches;
                    
                    let html = `<p style="margin-bottom: 15px;">Found <strong>${matches.length}</strong> matching email(s) (checked ${result.total_checked} total):</p>`;
                    
                    if (matches.length > 0) {
                        matches.forEach((email, i) => {
                            html += `
                                <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #28a745;">
                                    <strong>${i + 1}. ${email.title}</strong><br>
                                    <small style="color: #666;">
                                        From: ${email.sender} | 
                                        Date: ${email.date} | 
                                        Current tag: ${email.current_tag}
                                    </small>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p style="color: #666;">‚ùå No emails match this rule. Try different criteria.</p>';
                    }
                    
                    contentDiv.innerHTML = html;
                } else {
                    contentDiv.innerHTML = `<p style="color: #dc3545;">‚ùå Error: ${result.error}</p>`;
                }
            } catch (e) {
                contentDiv.innerHTML = `<p style="color: #dc3545;">‚ùå Error testing rule: ${e}</p>`;
            }
        }
        
        function saveRule() {
            alert('Save functionality - to be implemented');
            closeEditModal();
        }
        
        // Update handler description on selection
        document.addEventListener('DOMContentLoaded', () => {
            loadSenders();
            
            ['rule-sender', 'rule-subject', 'rule-body', 'rule-logic'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', updatePreview);
                    el.addEventListener('change', updatePreview);
                }
            });
            
            // Handler select change event
            const handlerSelect = document.getElementById('new-handler-select');
            if (handlerSelect) {
                handlerSelect.addEventListener('change', () => {
                    const handler = handlerSelect.value;
                    const desc = HANDLER_INFO[handler] || 'Handler description not available';
                    document.getElementById('handler-description').textContent = desc;
                });
            }
        });
    </script>
</body>
</html>
